{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 2,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "0fdb8ba7-3686-48b7-8a92-373004563730"
      },
      "gridPos": {
        "h": 23,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 2,
      "options": {
        "baidu": {
          "callback": "bmapReady",
          "key": ""
        },
        "editor": {
          "format": "auto",
          "height": 600
        },
        "editorMode": "code",
        "gaode": {
          "key": "",
          "plugin": "AMap.Scale,AMap.ToolBar"
        },
        "getOption": "data = JSON.parse(data.series[0].fields[0].values);\n\nconst graph = data.reduce(\n  (result, item) => {\n    if (!result.nodes.some((node) => node.id === item.community_id)) {\n      result.nodes.push({\n        id: item.community_id,\n        name: item.community,\n        symbolSize: 30,\n        symbol: replaceVariables(\"$communitySymbol\"),\n        itemStyle: {\n          color: item.community_color,\n        },\n        emphasis: {\n          label: {\n            show: true,\n            formatter: `${item.community}\\n(${item.community_adm3})`,\n          }\n        },\n      });\n    }\n    if (!result.nodes.some((node) => node.id === item.system_id)) {\n      result.nodes.push({\n        id: item.system_id,\n        name: item.system,\n        symbolSize: [25, 32],\n        symbol: replaceVariables(\"$systemSymbol\"),\n        itemStyle: {\n          color: item.system_color,\n        }\n      });\n    }\n    result.links.push(\n      {\n        source: item.community_id,\n        target: item.system_id,\n        value: item.provider,\n        label: {\n          show: true,\n          formatter: `${item.households}`\n        },\n        emphasis: {\n          label: {\n            show: true,\n            formatter: `{c}\\n${item.households} served households`,\n            rotate: 0,\n            position: \"inside\",\n            color: \"black\",\n            backgroundColor: \"white\"\n          }\n        },\n        lineStyle: {\n          color: item.provider_color,\n          width: Math.min(Math.max(item.households / 10, 1), 10)\n        }\n      },\n    );\n    return result;\n  },\n  { nodes: [], links: [] }\n);\n\nreturn {\n  series: {\n    type: \"graph\",\n    layout: \"force\",\n    data: graph.nodes,\n    links: graph.links,\n    roam: true,\n    force: {\n      repulsion: 300,\n      edgeLength: 100,\n    },\n    lineStyle: {\n      color: \"source\",\n      curveness: 0.3,\n    },\n    emphasis: {\n      focus: \"self\",\n    },\n    label: {\n      show: true,\n      position: \"bottom\",\n      formatter: \"{b}\",\n    },\n  },\n};",
        "google": {
          "callback": "gmapReady",
          "key": ""
        },
        "map": "none",
        "renderer": "canvas",
        "themeEditor": {
          "config": "{}",
          "height": 400,
          "name": "default"
        },
        "visualEditor": {
          "code": "const data = JSON.parse(context.panel.data.series[0].fields[0].values);\n\nconst communitySymbol = \"path://M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c0 2.7-.2 5.4-.5 8.1V472c0 22.1-17.9 40-40 40H456c-1.1 0-2.2 0-3.3-.1c-1.4 .1-2.8 .1-4.2 .1H416 392c-22.1 0-40-17.9-40-40V448 384c0-17.7-14.3-32-32-32H256c-17.7 0-32 14.3-32 32v64 24c0 22.1-17.9 40-40 40H160 128.1c-1.5 0-3-.1-4.5-.2c-1.2 .1-2.4 .2-3.6 .2H104c-22.1 0-40-17.9-40-40V360c0-.9 0-1.9 .1-2.8V287.6H32c-18 0-32-14-32-32.1c0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7L564.8 231.5c8 7 12 15 11 24z\";\nconst systemSymbol = \"path://M192 512C86 512 0 426 0 320C0 228.8 130.2 57.7 166.6 11.7C172.6 4.2 181.5 0 191.1 0h1.8c9.6 0 18.5 4.2 24.5 11.7C253.8 57.7 384 228.8 384 320c0 106-86 192-192 192zM96 336c0-8.8-7.2-16-16-16s-16 7.2-16 16c0 61.9 50.1 112 112 112c8.8 0 16-7.2 16-16s-7.2-16-16-16c-44.2 0-80-35.8-80-80z\";\n\nconst graph = data.reduce(\n  (result, item) => {\n    if (!result.nodes.some((node) => node.id === item.community_id)) {\n      result.nodes.push({\n        id: item.community_id,\n        name: item.community,\n        symbolSize: 30,\n        symbol: communitySymbol,\n        itemStyle: {\n          color: item.community_color,\n        },\n        emphasis: {\n          label: {\n            show: true,\n            formatter: `${item.community}\\n(${item.community_adm3})`,\n          }\n        },\n      });\n    }\n    if (!result.nodes.some((node) => node.id === item.system_id)) {\n      result.nodes.push({\n        id: item.system_id,\n        name: item.system,\n        symbolSize: [25, 32],\n        symbol: systemSymbol,\n        itemStyle: {\n          color: item.system_color,\n        }\n      });\n    }\n    result.links.push(\n      {\n        source: item.community_id,\n        target: item.system_id,\n        value: item.provider,\n        label: {\n          show: true,\n          formatter: `${item.households}`\n        },\n        emphasis: {\n          label: {\n            show: true,\n            formatter: `{c}\\n${item.households} served households`,\n            rotate: 0,\n            position: \"inside\",\n            color: \"black\",\n            backgroundColor: \"white\"\n          }\n        },\n        lineStyle: {\n          color: item.provider_color,\n          width: Math.min(Math.max(item.households / 10, 1), 10)\n        }\n      },\n    );\n    return result;\n  },\n  { nodes: [], links: [] }\n);\n\nreturn {\n  series: {\n    type: \"graph\",\n    layout: \"force\",\n    data: graph.nodes,\n    links: graph.links,\n    roam: true,\n    force: {\n      repulsion: 300,\n      edgeLength: 100,\n    },\n    lineStyle: {\n      color: \"source\",\n      curveness: 0.3,\n    },\n    emphasis: {\n      focus: \"self\",\n    },\n    label: {\n      show: true,\n      position: \"bottom\",\n      formatter: \"{b}\",\n    },\n  },\n};",
          "codeHeight": 600,
          "dataset": [],
          "series": []
        }
      },
      "pluginVersion": "5.3.0",
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "0fdb8ba7-3686-48b7-8a92-373004563730"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT json_agg(\n  json_build_object(\n    'community_id', c.id,\n    'community', c.name,\n    'community_color', color(c.wsp),\n    'community_adm3', c.adm3,\n    'provider_id', p.id,\n    'provider', p.name,\n    'provider_color', color(p.sep),\n    'system_id', s.id,\n    'system', s.name,\n    'system_color', color(s.wsi),\n    'households', csp.served_households\n  )\n)\nFROM communities_systems_providers csp\nJOIN systems s on s.id = csp.system_id\nJOIN communities c on c.id = csp.community_id\nJOIN providers p on p.id = csp.provider_id",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "transformations": [],
      "type": "volkovlabs-echarts-panel"
    }
  ],
  "refresh": "",
  "schemaVersion": 39,
  "tags": [],
  "templating": {
    "list": [
      {
        "hide": 2,
        "name": "communitySymbol",
        "query": "path://M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c0 2.7-.2 5.4-.5 8.1V472c0 22.1-17.9 40-40 40H456c-1.1 0-2.2 0-3.3-.1c-1.4 .1-2.8 .1-4.2 .1H416 392c-22.1 0-40-17.9-40-40V448 384c0-17.7-14.3-32-32-32H256c-17.7 0-32 14.3-32 32v64 24c0 22.1-17.9 40-40 40H160 128.1c-1.5 0-3-.1-4.5-.2c-1.2 .1-2.4 .2-3.6 .2H104c-22.1 0-40-17.9-40-40V360c0-.9 0-1.9 .1-2.8V287.6H32c-18 0-32-14-32-32.1c0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7L564.8 231.5c8 7 12 15 11 24z",
        "skipUrlSync": false,
        "type": "constant"
      },
      {
        "hide": 2,
        "name": "systemSymbol",
        "query": "path://M192 512C86 512 0 426 0 320C0 228.8 130.2 57.7 166.6 11.7C172.6 4.2 181.5 0 191.1 0h1.8c9.6 0 18.5 4.2 24.5 11.7C253.8 57.7 384 228.8 384 320c0 106-86 192-192 192zM96 336c0-8.8-7.2-16-16-16s-16 7.2-16 16c0 61.9 50.1 112 112 112c8.8 0 16-7.2 16-16s-7.2-16-16-16c-44.2 0-80-35.8-80-80z",
        "skipUrlSync": false,
        "type": "constant"
      }
    ]
  },
  "time": {
    "from": "now-6h",
    "to": "now"
  },
  "timepicker": {
    "hidden": true
  },
  "timezone": "",
  "title": "Mauri",
  "uid": "b13100b1-9c19-4fd5-8cd3-dd2dce09478a",
  "version": 10,
  "weekStart": ""
}